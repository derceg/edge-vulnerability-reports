# Summary

The web app install dialog allows a custom icon to be selected. If the dialog is closed immediately after an icon is selected, a UAF can occur in the browser process.

# Description

The issue here appears to be that when an image is selected, there's some processing that's done on a background thread. Specifically, EdgeWebAppCustomIcon::ReadCustomIconFile will be run in the background and will process the selected image.

If the dialog is closed (which is something that's done on the main UI thread), a UAF will occur if EdgeWebAppCustomIcon::ReadCustomIconFile is still processing the image.

That's because EdgeWebAppCustomIcon is owned by WebAppConfirmationView and the instance of that class will be destroyed when the dialog is closed.

Note that in the reproduction steps below, it's indicated that a larger image should be selected. The reason for that is that the larger the image is, the longer it will take to process. That then increases the chance that the tab removal will be run before the image processing completes.

If you select a small image, the processing may complete before the tab removal has a chance to run.

## Steps to Reproduce

1. Install the attached extension.
2. Once installed, the extension will open https://www.bing.com/ in a new tab.
3. From the app menu, select Apps > Install this site as an app.
4. Click the edit link in the web app install dialog.
5. From the open file dialog, select a larger image. A 768x1024 png file allows the issue to be reliably reproduced for me, so the image probably doesn't need to be too large.

   However, selecting a very large image (e.g. 10000x10000) allows the issue to be seen very clearly, as the processing will take a non-trivial amount of time (multiple seconds or more).
6. Once you've selected an image, the window that contains the tab opened in step 2 will regain focus. The extension will listen for that event and remove the tab (which will also close the web app install dialog). Provided that the selected image is still being processed at the time the tab removal occurs, a UAF will occur in the browser process.

It's also possible to reproduce this issue without an extension:

1. Load a website.
2. From the app menu, select Apps > Install this site as an app.
3. Click the edit link in the web app install dialog and select an image.
4. Once you've selected an image, immediately click the cancel button in the dialog.