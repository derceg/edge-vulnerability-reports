# Summary

When using vertical tabs, the group editor bubble can be shown by clicking the associated three dot menu within the tab strip. If the group is destroyed while the bubble is being shown and a menu item is then selected, an OOB read will occur in the browser process.

# Description

Normally, when the group editor bubble is shown, it will be destroyed when the group is destroyed. For example, if you right-click along the group header when using vertical tabs, the bubble will be shown and then destroyed when the group is destroyed.

If, however, you show the bubble by clicking the associated three dot menu, it will continue to be shown once the group has been destroyed.

Note that in the reproduction steps below, it's stated that a menu item should be focused before the group is destroyed. That's because the browser may crash with a null pointer dereference if the color picker needs to be repainted. I believe that's because the group header view is the anchor view for the group editor bubble. When the group is destroyed, the group header view is destroyed and the anchor is set to null. Which is then what leads to a crash when the color picker is repainted after the group has been destroyed.

However, if you do select one of the menu items, without causing the color picker to be repainted, an OOB read will occur in the browser process, due to the fact that the group no longer exists. For example, if you select the "Ungroup" item, the following call will result in an OOB read within TabGroupModel::GetTabGroup:

https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/ui/views/tabs/tab_group_editor_bubble_view.cc;l=561;drc=ccbdd134b0eca3aae5f0e5b028e80bcac2939b2b

Note that, in the demonstration given below, the group is moved from one window to another. As groups are stored on a per-window basis, that results in the original group being destroyed. The only reason that's done instead of calling chrome.tabs.ungroup is because of how the "Close group" handler is implemented.

When you select that menu item, BrowserTabStripModelDelegate::CreateHistoricalGroup will attempt to find the Browser instance that contains the specified group. If the group no longer exists at all (in any window), no instance will be found, which will ultimately trigger a null pointer dereference crash.

By moving the group to another window instead, a Browser instance will be found, but the browser will crash with the same OOB read at a later point.

One way to fix this issue might be to update  EdgeTabGroupButtonContainer::OpenTabGroupEditorBubble to call TabGroupHeader::ShowContextMenuForViewImpl, rather than call TabGroupEditorBubbleView::Show directly. The advantage would then be that the TabGroupHeader class would destroy the group editor bubble when necessary (via the nested EditorBubbleTracker class).

Aside from ensuring that the bubble is destroyed when the group is destroyed, future issues in this area could also be prevented by changing the DHCECK in TabGroupModel::GetTabGroup to a CHECK:

https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/ui/tabs/tab_group_model.cc;l=42;drc=46bbb9795fcc1934c6cfbec096764f888c4d400a

That function unconditionally dereferences the iterator returned by find(). It makes no sense to do that or proceed in any way if the group isn't contained within the map.

## Steps to Reproduce

1. Turn on vertical tabs.
2. Install the attached extension.
3. Once installed, the extension will create a tab and add it to a group.
4. Once that's happened, click the three dot menu for the group within the tab strip.
5. Once the group editor bubble has opened, either move the mouse pointer over one of the menu items or focus one of the items with the keyboard. As described above, focusing an item only after the group has been destroyed may cause the browser to crash with a null pointer dereference if the color picker needs to be repainted (e.g. because the mouse moves over it).
6. Ten seconds after creating the grouped tab, the extension will move the group to a new window. This will cause the original group to be destroyed, however, the group editor bubble will continue to be shown.
7. Select the menu item you focused in step 5 (e.g. by clicking the mouse or pressing enter). You can also select one of the other menu items, so long as doing so doesn't cause the color picker to be repainted. This should then cause an OOB read in the browser process, as described above.

   Aside from selecting a menu item, typing a character into the name field will also trigger the same OOB read.

   Additionally, selecting another color in the color picker will also trigger the OOB read. You can do that by, for example, setting the focus to the color picker control before the group is destroyed and then selecting another color with the keyboard after the group has been destroyed.