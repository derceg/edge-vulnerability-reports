# Summary

The Edge Feedback app uses a private API method (chrome.edgeFeedbackPrivate.saveBytesToFile) to save video reproduction data to a local file. This method doesn't validate the filename it receives, allowing the caller to write files to arbitrary locations.

Using one of three current issues in Chromium, it's possible for an extension to execute code within the context of another extension/app, including the Feedback app. This allows an extension to write an arbitrary file into the user's startup folder, which will be run when they next sign in.

# Description

As mentioned above, the core issue here is that chrome.edgeFeedbackPrivate.saveBytesToFile doesn't validate the filename it receives. From an attacker's point of view, I think there are a few useful properties in the behavior of this method:

1. It allows you to write to arbitrary locations.
2. It allows you to overwrite existing files.
3. Files created in this way don't have the mark of the web applied and don't pass through the typical download screening. So it could be a good way of creating an executable or other type of file that would be blocked when downloaded normally.

For an extension to take advantage of this method, it has to have the ability to run code within the context of other extensions/apps. This is something that's possible within the devtools:// context.

The devtools has the ability to load an extension page within an iframe and then run code within it. This is then what powers the devtools extension functionality (https://developer.chrome.com/extensions/devtools).

I'm aware of three current methods that allow an extension to run code within the context of a devtools:// page. Each of these methods would then allow an extension to run code within the context of the Feedback app and ultimately escape the sandbox.

However, the three issues associated with those methods have only been reported to the Chromium project recently and the fixes aren't yet in the stable version. As I'm not sure about the process of disclosure here given that, I've created a reproduction extension that doesn't use any of the three methods and instead requires some manual work.

It is possible to do the same thing without any user interaction, however, by using one of the three methods. That is, all the user would have to do would be to install the extension.

I can provide links to the Chromium issues if you would like to verify the above and you have the ability to access security issues.

## Steps to Reproduce

The steps below have been tested on Edge 80.0.361.111 (Official build) (64-bit) and 83.0.478.0 (Official build) canary (64-bit).

1. Install the attached extension.
2. Once installed, the extension will open a new tab at devtools://devtools/bundled/inspector.html.
3. Run the following code within the context of this tab:

   ```javascript
   let script = document.createElement('script');
   script.src = "chrome-extension://mnglclahokidbdbhfmdncdjacnbbcdbn/devtools.js";
   document.head.appendChild(script);
   ```
   
   This can be done by opening the devtools for the tab and executing the code. Note that you'll need to update the extension ID to match the ID set on installation.

4. Once devtools.js is loaded, it will run code within the context of the Feedback app by going through the following process. First, it makes the call below:

   ```javascript
   let script = "â€¦";
   DevToolsAPI.sendMessageToEmbedder("registerExtensionsAPI", ["chrome-extension://ihmafllikibpmigkcoadcmckbfhibefp", script]);
   ```
   
   It then adds an iframe to the page that points to chrome-extension://ihmafllikibpmigkcoadcmckbfhibefp/js/feedback.js. When this iframe loads, the script above runs.

5. The script will write a bat file into the user's startup folder using the following calls:

   ```javascript
   const batFileContents = "echo Startup bat file\npause";
   let textEncoder = new TextEncoder();
   let encodedData = textEncoder.encode(batFileContents);
   chrome.edgeFeedbackPrivate.saveBytesToFile("..\..\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\startup.bat", encodedData, function () {});
   ```

6. If you sign out of Windows, then sign back in, this bat file should execute.