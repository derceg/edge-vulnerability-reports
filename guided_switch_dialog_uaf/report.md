# Summary

The guided switch dialog allows the user to switch to a different profile that is logged into a target site. If that dialog is moved from one browser window to another, the original browser window is closed and the dialog itself is then closed, a UAF will occur in the browser process when a browser window event is dispatched (e.g. when a window is created or closed).

# Description

The issue here appears to be fairly simple. The EdgeSigninReactDialogHandler constructor calls BrowserList::AddObserver, though it only does that if the Browser parameter it's passed is non-null:

```c++
browser_ = browser;

if (browser) {
    BrowserList::AddObserver(this);
}
```

Then, if the browser window associated with the Browser parameter is closed, while the guided switch dialog is still open, the browser_ member variable will be reset:

```c++
if (browser_ == browser) {
    browser_ = nullptr;
}
```

Finally, when the dialog is closed, the EdgeSigninReactDialogHandler destructor will be invoked, which will call BrowserList::RemoveObserver:

```c++
if (browser_) {
    BrowserList::RemoveObserver(this);
}
```

However, that's only done if the browser_ member is non-null. That's an issue, as the guided switch dialog is tab-modal and can be moved from one browser window to another. If that occurs and the original browser window is closed, the browser_ member will be reset to null and then when the dialog is closed, the BrowserList observer won't be removed. That then leads to a use-after-free whenever a BrowserList event is dispatched (e.g. because a browser window has been created or closed).

## Steps to Reproduce

1. Ensure there are at least two profiles: one that's logged into a Microsoft account and one that's not.
2. Open a browser window for the profile that's not logged in.
3. Install the attached extension.
4. Once installed, the extension will load https://login.live.com/ in a new window. Doing this will result in the guided switch dialog being shown (since the other profile can be used to log in to the site).
5. The extension will then move the tab to a new window. This will result in the original window (created in step 4) being closed.
6. The tab will then be navigated to about:blank. This will result in the guided switch dialog being closed, however the BrowserList observer won't be removed, since the original window was closed.
7. The extension will then create a new window. This will result in a UAF, as the BrowserList class will attempt to invoke a method on the now destroyed EdgeSigninReactDialogHandler object.