# Summary

A mini menu can be shown when selecting text on a page. If the associated tab is closed and one of the menu items is then selected or the menu is closed, a use-after-free will occur in the browser process.

# Description

The edge::quick_search::ContextMenuModel class holds a pointer to the associated WebContents. When the tab is closed, the menu will continue to be shown. If one of the menu items is then selected, or the menu is closed, a use-after-free will occur when the stored WebContents pointer is used.

In the case where a menu item is selected, edge::quick_search::ContextMenuModel::RecordWebOOUIDetailsUKM will be called. That method will access the stored WebContents.

Additionally, if the menu is expanded from the initial three dot menu, edge::quick_search::ContextMenuModel::Init will access the stored WebContents.

When the menu is closed, edge::quick_search::ContextMenuModel::RecordDismissMenuUKM will be called, which will also access the stored WebContents.

## Steps to Reproduce

The first demonstration here shows how an extension could trigger the issue.

1. Ensure the "Show mini menu when selecting text" option is enabled (which it should be by default).
2. Install the attached extension (composed of manifest.json and background.js).
3. Once installed, the extension will load manifest.json in a new tab. Select some of the text on that page to bring up the mini menu. Leave the mini menu in place.
4. Five seconds after opening the tab, the extension will close it.
5. At this point, any action you take with the mini menu should trigger a UAF, as described above. That is, a UAF should occur if you close the menu, or expand the menu from the initial three dot version, or select one of the menu items (if you expanded the menu before the tab was closed).

   The extension could also trigger the UAF by creating a new focused window, since that would cause the menu to be closed.

   Finally, an extension with the debugger permission could trigger the issue without any user interaction post-install by using the Input.dispatchMouseEvent method to bring up the mini menu.


The second demonstration here shows how a regular webpage can trigger the issue, provided two conditions are met: the first is that the page be able to call window.close and the second is that the user clicks the page a single time.

1. Ensure the "Show mini menu when selecting text" option is enabled.
2. Open index.html in the browser. As mentioned above, the page needs to be able to call window.close. It will be able to do that if the tab has no other history entries. You can ensure that's the case by, for example, opening the page from a bookmark, or by using Alt+Enter in the address bar.
3. Once index.html has loaded, click anywhere on the page. index.html has a click handler that will select the text on the page. That will result in the mini menu being shown. The click handler will also call window.close.
4. As with the case above, any action that you take with the mini menu once the tab has been closed should trigger a UAF.